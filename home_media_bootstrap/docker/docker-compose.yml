version: "3.9"

services:
  nfs-mounter:
    image: alpine:latest
    container_name: nfs-mounter
    privileged: true
    restart: unless-stopped
    environment:
      - NAS_IP=${NAS_IP}
    command: >
      sh -c "
        apk add --no-cache nfs-utils &&
        mkdir -p /mnt/p2p /mnt/p2p_sabnzbd /mnt/p2p_sonarr &&
        mount -t nfs -o vers=3,nolock ${NAS_IP}:/mnt/md0/p2p /mnt/p2p &&
        mount -t nfs -o vers=3,nolock ${NAS_IP}:/mnt/md0/p2p_sabnzbd /mnt/p2p_sabnzbd &&
        mount -t nfs -o vers=3,nolock ${NAS_IP}:/mnt/md0/p2p_sonarr /mnt/p2p_sonarr &&
        echo 'âœ… All NFS shares mounted successfully.' &&
        tail -f /dev/null
      "
    networks:
      - default

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    environment:
      - PUID=2000
      - PGID=2000
      - TZ=America/Chicago
    volumes:
      - sabnzbd-data:/config
      - p2p-data:/mnt/p2p
    depends_on:
      - nfs-mounter
    ports:
      - 8080:8080
    restart: unless-stopped

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      - PUID=2000
      - PGID=2000
      - TZ=America/Chicago
    volumes:
      - sonarr-data:/config
      - p2p-data:/mnt/p2p
    depends_on:
      - nfs-mounter
    ports:
      - 8989:8989
    restart: unless-stopped

volumes:
  sabnzbd-data:
    driver_opts:
      type: "nfs"
      o: "addr=${NAS_IP},nfsvers=3,nolock,rw"
      device: ":/mnt/md0/p2p_sabnzbd"
  sonarr-data:
    driver_opts:
      type: "nfs"
      o: "addr=${NAS_IP},nfsvers=3,nolock,rw"
      device: ":/mnt/md0/p2p_sonarr"
  p2p-data:
    driver_opts:
      type: "nfs"
      o: "addr=${NAS_IP},nfsvers=3,nolock,rw"
      device: ":/mnt/md0/p2p"
